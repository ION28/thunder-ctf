<!doctype html>
<html>

<head>
  <title>Thunder CTF</title>
  <link rel="stylesheet" type="text/css" href="../static/style.css">
  <link href='https://fonts.googleapis.com/css?family=Nova+Square' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Roboto:400,500,300' rel='stylesheet' type='text/css'>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <header>
    <div id="nav">
      <center>
        <h1>Thunder CTF</h1>
      </center>
    </div>
  </header>
  <section>
    <div class=page>

      <center>
        <h2>a3password</h2>
        <pre>python3 thunder.py create a3password
python3 thunder.py destroy a3password</pre>

        
          
            <p>In this level, the secret is hidden somewhere in the cloud infrastructure. Use the given compromised credentials to find it</p>
<button class="accordion">Hint 1</button>
        <div class="panel"><p>The credentials have the permission cloudfunctions.functions.list</p>
</div><button class="accordion">Hint 2</button>
        <div class="panel"><p>List the cloud functions in the project:</p>
<pre>gcloud functions list</pre>
</div><button class="accordion">Hint 3</button>
        <div class="panel"><p>Get more information about the function:</p>
<pre>gcloud functions describe [function]</pre>
</div><button class="accordion">Hint 4</button>
        <div class="panel"><p>Try calling the function:</p>
<pre>curl [httpsTrigger]</pre>
</div><button class="accordion">Hint 5</button>
        <div class="panel"><p>The function returned a 403 response, meaning you need to authenticate your request. Google's documentation for cloud function authentication can be found <a class="inline" href="https://cloud.google.com/functions/docs/securing/authenticating">here</a>.</p>
</div><button class="accordion">Hint 6</button>
        <div class="panel"><p>To authenticate the request, we need to include an "identity" token (different than an "access" token) in the request.</p>
<p>Generate an identity token for the service account:</p>
<pre>gcloud auth print-identity-token</pre>
<p>Call the function using the token:</p>
<pre>curl [httpsTrigger] -H "authorization: bearer [identity-token]</pre>
<p>Or, do this in one command:</p>
<pre>curl [httpsTrigger] -H "authorization: bearer $(gcloud auth print-identity-token)"</pre>
</div><button class="accordion">Hint 7</button>
        <div class="panel"><p>The function wants a "password" argument. Include it by adding "?password=[password]" to the end of the url.</p>
</div><button class="accordion">Hint 8</button>
        <div class="panel"><p>The credentials you are using have the permission cloudfunctions.functions.sourceCodeGet. Use it to figure out what the function is doing.</p>
</div><button class="accordion">Hint 9</button>
        <div class="panel"><p>Use the cloudfunctions REST API method projects.locations.functions.generateDownloadUrl to download the source code of the function.</p>
</div><button class="accordion">Hint 10</button>
        <div class="panel"><p>Go to the REST reference <a class="inline" href="https://cloud.google.com/functions/docs/reference/rest/v1/projects.locations.functions/getIamPolicy">here</a>. This documentation describes how to make a request to the API to create a link to download the source code of a cloud function.</p>
<p>In this case, you can use the "Try this API" feature on the right. Fill in the "name" field, formatting it as the documentation specifies. You will also need an access token, which is not the same as the identity token you generated earlier. To generate an access token, run:</p>
<pre>gcloud auth print-access-token</pre>
<p>In the "Try this API" window, click "show standard parameters," and paste the access token into the field "access token."</p>
<img src="../img/a3password/tryapi1.png">
<p>Leave the request body empty, and uncheck both "Google Oauth 2.0" and "API key," as we are using the access token for authentication. Click execute, and download the source code by curling or browsing the link given in the response.</p>
<img src="../img/a3password/tryapi2.png">
</div><button class="accordion">Hint 11</button>
        <div class="panel"><p>In main.py, we see in line 19 that the function expects XOR_PASSWORD, an environment variable, to be equal to the result of the bitwise xor of the entered password and XOR_FACTOR (password ^ XOR_FACTOR).</p>
</div><button class="accordion">Hint 12</button>
        <div class="panel"><p>XOR_FACTOR is a constant in the code, and XOR_PASSWORD is an environment variable that can be found by running:</p>
<pre>gcloud functions describe [function]</pre>
<p>To find the password, compute the result of XOR_PASSWORD ^ XOR_FACTOR. Call the function, passing the correct password to the "password" argument.</p>
</div></center>

    </div>
  </section>
  <p>
    <p>
      <p>
        <footer class="clearfix">
          <center>PSU CTF: Work done under NSF Award #1821841</center>
        </footer>
        <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
        <script src="../static/accordion.js"></script>
        <script>
          $(function () {
            $(window).scroll(function () {
              var winTop = $(this).scrollTop();
              if (winTop >= 10) {
                $("body").addClass("shrink-header");
              } else {
                $("body").removeClass("shrink-header");
              }
            });
          });
        </script>
</body>

</html>