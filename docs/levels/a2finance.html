<!doctype html>
<html>

<head>
  <title>Thunder CTF</title>
  <link rel="stylesheet" type="text/css" href="../static/style.css">
  <link href='https://fonts.googleapis.com/css?family=Nova+Square' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Roboto:400,500,300' rel='stylesheet' type='text/css'>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <header>
    <div id="nav">
      <center>
        <h1>Thunder CTF</h1>
      </center>
    </div>
  </header>
  <section>
    <div class=page>

      <center>
        <h2>a2finance</h2>
        <pre>python3 thunder.py create a2finance
python3 thunder.py destroy a2finance</pre>

        
          
            <p>In this level, the secret is the (fake) credit card number of the person assigned to you upon level creation. Use the compromised service account that is given to you to navigate the cloud infrastructure to find the credit card.</p>

          
            <p>Upon level creation, the name of the target is written to start/a2finance.txt, and the service account key file is written to start/a2-access.json.</p>

          
            <p></p>

          
            <p>From this level on, you will need to be able to figure out the project-wide permissions of service account credentials. To do this, we have provided you with a script that repeatedly queries the projects.testIamPermissions REST api function to figure out which permissions given credentials have. The script is stored at scripts/test-permissions.py. We recommend glancing over the script to understand how it works, but to run it just set PROJECT_ID and either SERVICE_ACCOUNT_KEY_FILE or ACCESS_TOKEN, then run the script, and it will output the permissions of the given credentials. By default, it will test the given service account key file, but if USE_ACCESS_TOKEN is set to True, it will test the given access token.</p>

          
            <pre># If set to true, credentials will be created using ACCESS_TOKEN instead of SERVICE_ACCOUNT_KEY_FILE

          USE_ACCESS_TOKEN = False

          # Only one of the following need to be set:

          SERVICE_ACCOUNT_KEY_FILE = 'path/to/key/file'

          ACCESS_TOKEN = ''

          # Set the project ID

          PROJECT_ID = '[project-id]'</pre>
<button class="accordion">Hint 1</button>
        <div class="panel"><p>Activate the service account in the gcloud cli</p>
</div><button class="accordion">Hint 2</button>
        <div class="panel"><p>The command to do so is:</p>
<pre>gcloud auth activate-service-account --key-file=start/a2-access.json</pre>
</div><button class="accordion">Hint 3</button>
        <div class="panel"><p>Run the permissions testing script on the given service account credentials</p>
</div><button class="accordion">Hint 4</button>
        <div class="panel"><p>In scripts/test-permissions.py, set PROJECT_ID to your project id and SERVICE_ACCOUNT_KEY_FILE to 'start/a2-access.json', then run:</p>
<pre>python3 scripts/test-permissions.py</pre>
</div><button class="accordion">Hint 5</button>
        <div class="panel"><p>One of the permissions you have is storage.buckets.list. Try using this permission.</p>
</div><button class="accordion">Hint 6</button>
        <div class="panel"><p>The command to do so is:</p>
<pre>gsutil ls</pre>
</div><button class="accordion">Hint 7</button>
        <div class="panel"><p>There's a bucket in the project. Check out what's inside of it.</p>
</div><button class="accordion">Hint 8</button>
        <div class="panel"><p>Download the bucket:</p>
<pre>gsutil cp -r gs://[bucket-name] .</pre>
</div><button class="accordion">Hint 9</button>
        <div class="panel"><p>The bucket stores a git repository. There might be something interesting in the git history.</p>
</div><button class="accordion">Hint 10</button>
        <div class="panel"><p>View the previous git commits:</p>
<pre>git log</pre>
</div><button class="accordion">Hint 11</button>
        <div class="panel"><p>The most recent commit mentions a key file getting committed by the first commit.</p>
</div><button class="accordion">Hint 12</button>
        <div class="panel"><p>Checkout the previous commit:</p>
<pre>git checkout &ltold commit name&gt</pre>
</div><button class="accordion">Hint 13</button>
        <div class="panel"><p>There's an ssh key file! It could be used to login to a Google Compute Engine instance.</p>
</div><button class="accordion">Hint 14</button>
        <div class="panel"><p>List the compute instances in the project:</p>
<pre>gcloud compute instances list</pre>
</div><button class="accordion">Hint 15</button>
        <div class="panel"><p>Get more information on the running instance:</p>
<pre>gcloud compute instances describe [instance-name]</pre>
</div><button class="accordion">Hint 16</button>
        <div class="panel"><p>In the metadata of the instance, there is information about the ssh keys that can be used to login to instance</p>
</div><button class="accordion">Hint 17</button>
        <div class="panel"><p>SSH into the instance:</p>
<pre>ssh -i [key-file] clouduser@[instance-external-ip]</pre>
</div><button class="accordion">Hint 18</button>
        <div class="panel"><p>Based on the name of the instance, it probably has access to Google Cloud's logging service, Stackdriver Logging.</p>
</div><button class="accordion">Hint 19</button>
        <div class="panel"><p>List the logs on the project:</p>
<pre>gcloud logging logs list</pre>
</div><button class="accordion">Hint 20</button>
        <div class="panel"><p>Most of the logs are automatically generated logs of events of other resources, which may not provide much useful information, but one of the logs is named "transactions"</p>
</div><button class="accordion">Hint 21</button>
        <div class="panel"><p>Read the log named transaction. You will need to specify it's full resource name:</p>
<pre>gcloud logging read "logName=projects/[project-id]/logs/[log-name]"</pre>
</div><button class="accordion">Hint 22</button>
        <div class="panel"><p>You won't want to look through all the log entries, so try filtering it to only show the name you are looking for. The documentation for logging filtration can be found <a class="inline" href="cloud.google.com/logging/docs/view/advanced-queries">here</a>.</p>
</div><button class="accordion">Hint 23</button>
        <div class="panel"><p>The command to get the log entry you want is:</p>
<pre>gcloud logging read "logName=projects/[project-id]/logs/[log-name] AND jsonPayload.name=[name]"</pre>
</div></center>

    </div>
  </section>
  <p>
    <p>
      <p>
        <footer class="clearfix">
          <center>PSU CTF: Work done under NSF Award #1821841</center>
        </footer>
        <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
        <script src="../static/accordion.js"></script>
        <script>
          $(function () {
            $(window).scroll(function () {
              var winTop = $(this).scrollTop();
              if (winTop >= 10) {
                $("body").addClass("shrink-header");
              } else {
                $("body").removeClass("shrink-header");
              }
            });
          });
        </script>
</body>

</html>