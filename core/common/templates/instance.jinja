imports:
- path: service_account.jinja

{% set INSTANCE_NAME = env['name'] %}
{% set SERVICE_ACCOUNT_NAME = env['name'] + "-sa" %}

resources:
- type: service_account.jinja
  name: {{ SERVICE_ACCOUNT_NAME }}
- type: compute.v1.instance
  name: {{ INSTANCE_NAME }}
  properties:
    zone: {{ properties["zone"] }}
    machineType: zones/{{ properties["zone"] }}/machineTypes/g1-small
    disks:
    - boot: true
      autoDelete: true
      initializeParams:
        sourceImage: projects/ubuntu-os-cloud/global/images/family/ubuntu-1804-lts
    {% if properties['openExternal'] == true %}
    networkInterfaces:
    - network: global/networks/default
      accessConfigs:
      - type: ONE_TO_ONE_NAT
    {% endif %}
    serviceAccounts:
    - email: $(ref.{{ SERVICE_ACCOUNT_NAME }}.email)
      {% if properties['sa_scopes'] %}
      scopes:
      {% for scope in properties['sa_scopes'] %}
      - {{ scope }}
      {% endfor %}
      {% endif %}
    {% if properties['ssh_credentials'] or properties['startup_script'] %}
    metadata:
      items:
      {% if properties['ssh_credentials'] %}
      - key: ssh-keys
        value: {{ properties['ssh_credentials']['username'] }}:{{ properties['ssh_credentials']['public_key'] }} {{ properties['ssh_credentials']['username'] }}
      {% endif %}
      {% if properties['startup_script'] %}
      - key: startup-script
        value: |
          {{ properties['startup_script']|indent(10) }}
      {% endif %}
    {% endif %}