imports:
- path: service_account.jinja

{% set INSTANCE_ID = env['name'] + "-" + env["deployment"] %}
{% set SERVICE_ACCOUNT_ID = "sa-" + env['name'] %}

resources:
- type: service_account.jinja
  name: {{ SERVICE_ACCOUNT_ID }}
  properties:
    {% for sa_property in properties['sa_properties'] %}
    {{ sa_property }}
    {% endfor %}
- type: compute.v1.instance
  name: {{ INSTANCE_ID }}
  properties:
    zone: {{ properties["zone"] }}
    machineType: zones/{{ properties["zone"] }}/machineTypes/f1-micro
    disks:
    - boot: true
      autoDelete: true
      initializeParams:
        sourceImage: projects/ubuntu-os-cloud/global/images/family/ubuntu-1804-lts
    networkInterfaces:
    - network: global/networks/default
    serviceAccounts:
    - email: {{ SERVICE_ACCOUNT_ID + "-" + env['deployment'] }}@{{ env['project'] }}.iam.gserviceaccount.com
      scopes:
      - https://www.googleapis.com/auth/logging.read
    metadata:
      items:
      - key: ssh-keys
        value: {{ properties['ssh_username'] }}:{{ properties['ssh_public_key']}} {{ properties['ssh_username'] }}
#      - key: startup-script
#        value: "{{properties['startup_script']}}"