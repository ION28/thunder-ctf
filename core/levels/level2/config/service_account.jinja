
{% set SERVICE_ACCOUNT_NAME=env['name']+ '-' + env["deployment"] %}

{% if properties['permissions'] %}
{% set ROLE_NAME = 'role_' + (SERVICE_ACCOUNT_NAME|replace('-','_')) + "_" + properties['nonce'] %}
{% endif %}

resources:
{% if properties['permissions'] %}
- name: {{ ROLE_NAME }}
  type: gcp-types/iam-v1:projects.roles
  properties:
    parent: projects/{{ env["project"] }}
    roleId: {{ ROLE_NAME }}
    role:
      title: Role for service account {{ SERVICE_ACCOUNT_NAME }}
      includedPermissions:
      {% for permission in properties['permissions'] %}
      - {{permission}}
      {% endfor %}
{% endif %}
- name: {{ SERVICE_ACCOUNT_NAME }}
  type: iam.v1.serviceAccount
  properties:
    accountId: {{ SERVICE_ACCOUNT_NAME }}
    displayName: {{ SERVICE_ACCOUNT_NAME }}
  accessControl:
    gcpIamPolicy:
      bindings: 
      - members:
        - "serviceAccount:{{ SERVICE_ACCOUNT_NAME }}@{{ env['project'] }}.iam.gserviceaccount.com"
        {% if properties['permissions'] %}
        role: projects/{{ env['project'] }}/roles/{{ ROLE_NAME }}
        {% else %}
        role: {{ properties['role']}}
        {% endif %}
